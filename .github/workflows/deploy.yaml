# ==============================================================================
# DEPLOY WORKFLOW - Deploy to Dokploy (Staging & Production)
# ==============================================================================
# Triggers on:
#   - Manual trigger to deploy to Staging or Production via Dokploy
#   - Requires valid Dokploy credentials in secrets
# ==============================================================================

name: Deploy

on:
  workflow_run:
    workflows: [ "CI Pipeline" ]
    branches: [ develop, main ]
    types: [ completed ]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to (via Dokploy)"
        required: true
        type: choice
        options:
          - staging
          - production
      dry_run:
        description: "Dry run (validate without deploying)"
        required: false
        default: false
        type: boolean

env: { }

jobs:
  # ============================================================================
  # DETERMINE TRIGGER AND ENVIRONMENT
  # ============================================================================
  init:
    name: Initialize Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      branch: ${{ steps.set-env.outputs.branch }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}
      is_manual: ${{ steps.set-env.outputs.is_manual }}

    steps:
      - name: Determine Environment
        id: set-env
        run: |
          BRANCH=""
          ENVIRONMENT=""
          SHOULD_DEPLOY="false"

          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Auto-triggered by CI Pipeline
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          
            if [ "$BRANCH" = "main" ]; then
              ENVIRONMENT="production"
              # Check if production credentials are configured
              if [ -n "${{ secrets.DOKPLOY_PRODUCTION_APPLICATION_ID }}" ]; then
                SHOULD_DEPLOY="true"
              fi
            elif [ "$BRANCH" = "develop" ]; then
              ENVIRONMENT="production"
              # Check if production credentials are configured (develop also deploys to production)
              if [ -n "${{ secrets.DOKPLOY_PRODUCTION_APPLICATION_ID }}" ]; then
                SHOULD_DEPLOY="true"
              fi
            fi
          
            IS_MANUAL="false"
          else
            # Manually triggered
            IS_MANUAL="true"
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          
            if [ "$ENVIRONMENT" = "production" ]; then
              if [ -n "${{ secrets.DOKPLOY_PRODUCTION_APPLICATION_ID }}" ]; then
                SHOULD_DEPLOY="true"
              fi
            elif [ "$ENVIRONMENT" = "staging" ]; then
              if [ -n "${{ secrets.DOKPLOY_STAGING_APPLICATION_ID }}" ]; then
                SHOULD_DEPLOY="true"
              fi
            fi
          fi

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "is_manual=$IS_MANUAL" >> $GITHUB_OUTPUT

  # ============================================================================
  # DEPLOY TO STAGING VIA DOKPLOY
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: init
    if: needs.init.outputs.is_manual == 'true' && needs.init.outputs.environment == 'staging' && needs.init.outputs.should_deploy == 'true'
    environment:
      name: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate Dokploy Credentials
        run: |
          if [ -z "${{ secrets.DOKPLOY_URL }}" ] || [ -z "${{ secrets.DOKPLOY_AUTH_TOKEN }}" ] || [ -z "${{ secrets.DOKPLOY_STAGING_APPLICATION_ID }}" ]; then
            echo "Missing Dokploy credentials in secrets"
            echo "Required secrets:"
            echo "  - DOKPLOY_URL"
            echo "  - DOKPLOY_AUTH_TOKEN"
            echo "  - DOKPLOY_STAGING_APPLICATION_ID"
            exit 1
          fi
          echo "All Dokploy credentials are configured"

      - name: Display Deployment Info
        run: |
          echo "## Staging Deployment Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** Manual (workflow_dispatch)" >> $GITHUB_STEP_SUMMARY
          echo "- **Dokploy URL:** ${{ secrets.DOKPLOY_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Application ID:** ${{ secrets.DOKPLOY_STAGING_APPLICATION_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Dokploy Deployment
        if: ${{ !github.event.inputs.dry_run }}
        run: |
          echo "Triggering Dokploy deployment for Staging..."
          response=$(curl -fsS -X 'POST' \
            '${{ secrets.DOKPLOY_URL }}/api/application.deploy' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -H 'x-api-key: ${{ secrets.DOKPLOY_AUTH_TOKEN }}' \
            -d "{
              \"applicationId\": \"${{ secrets.DOKPLOY_STAGING_APPLICATION_ID }}\"
            }")

          echo "Dokploy deployment response:"
          echo "$response"

          # Check if deployment was successful
          if echo "$response" | grep -q "error" || echo "$response" | grep -q "failed"; then
            echo "Deployment failed"
            exit 1
          fi
          echo "Deployment triggered successfully"

      - name: Dry Run Notice
        if: ${{ github.event.inputs.dry_run }}
        run: |
          echo "## Dry Run Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment was **NOT** executed (dry run enabled)." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # DEPLOY TO PRODUCTION VIA DOKPLOY
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: init
    if: needs.init.outputs.environment == 'production' && needs.init.outputs.should_deploy == 'true'
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate Dokploy Credentials
        run: |
          if [ -z "${{ secrets.DOKPLOY_URL }}" ] || [ -z "${{ secrets.DOKPLOY_AUTH_TOKEN }}" ] || [ -z "${{ secrets.DOKPLOY_PRODUCTION_APPLICATION_ID }}" ]; then
            echo "Missing Dokploy credentials in secrets"
            echo "Required secrets:"
            echo "  - DOKPLOY_URL"
            echo "  - DOKPLOY_AUTH_TOKEN"
            echo "  - DOKPLOY_PRODUCTION_APPLICATION_ID"
            exit 1
          fi
          echo "All Dokploy credentials are configured"

      - name: Production Confirmation
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            TRIGGER="Automatic (CI Pipeline completed on $BRANCH)"
          else
            TRIGGER="Manual (workflow_dispatch)"
          fi

          echo "## Production Deployment Confirmation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "DEPLOYING TO PRODUCTION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** $TRIGGER" >> $GITHUB_STEP_SUMMARY
          echo "- **Dokploy URL:** ${{ secrets.DOKPLOY_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Application ID:** ${{ secrets.DOKPLOY_PRODUCTION_APPLICATION_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Dokploy Deployment
        if: ${{ github.event_name == 'workflow_run' || !github.event.inputs.dry_run }}
        run: |
          echo "Triggering Dokploy deployment for Production..."
          response=$(curl -fsS -X 'POST' \
            '${{ secrets.DOKPLOY_URL }}/api/application.deploy' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -H 'x-api-key: ${{ secrets.DOKPLOY_AUTH_TOKEN }}' \
            -d "{
              \"applicationId\": \"${{ secrets.DOKPLOY_PRODUCTION_APPLICATION_ID }}\"
            }")

          echo "Dokploy deployment response:"
          echo "$response"

          # Check if deployment was successful
          if echo "$response" | grep -q "error" || echo "$response" | grep -q "failed"; then
            echo "Deployment failed"
            exit 1
          fi
          echo "Deployment triggered successfully"

      - name: Dry Run Notice
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run }}
        run: |
          echo "## Dry Run Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment was **NOT** executed (dry run enabled)." >> $GITHUB_STEP_SUMMARY
